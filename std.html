<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time GPIO Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
        var socket = io();  // Connect to Flask-SocketIO server

        function addSwitch() {
            let name = document.getElementById("deviceName").value;
            let pin = document.getElementById("gpioPin").value;

            if (!name) {
                alert("Please enter a name.");
                return;
            }

            let container = document.getElementById("switchesContainer");

            let switchDiv = document.createElement("div");
            switchDiv.classList.add("switch-box");
            switchDiv.setAttribute("id", "switch-" + pin);

            switchDiv.innerHTML = `
                <button class="close-btn" onclick="removeSwitch('${pin}')">X</button>
                <strong>${name} (GPIO ${pin})</strong>
                <label class="switch">
                    <input type="checkbox" id="toggle-${pin}" data-pin="${pin}" onchange="toggleGPIO('${pin}')">
                    <span class="slider"></span>
                </label>
            `;

            container.appendChild(switchDiv);
            hideForm();
        }

        function removeSwitch(pin) {
            let switchDiv = document.getElementById("switch-" + pin);
            if (switchDiv) {
                switchDiv.remove();
            }
        }

        function toggleGPIO(pin) {
            let state = document.getElementById(`toggle-${pin}`).checked;
            socket.emit('toggle_gpio', { pin: pin, state: state });  // Send toggle request to Flask
        }

        // Listen for updates from the server
        socket.on('update_gpio', function(data) {
            let switchElement = document.getElementById(`toggle-${data.pin}`);
            if (switchElement) {
                switchElement.checked = data.state;
            }
        });

        // When a client connects, fetch all GPIO states
        socket.on('update_all_gpio', function(states) {
            for (let pin in states) {
                let switchElement = document.getElementById(`toggle-${pin}`);
                if (switchElement) {
                    switchElement.checked = states[pin];
                }
            }
        });

        // Request the current GPIO states when the page loads
        document.addEventListener("DOMContentLoaded", function() {
            socket.emit('connect');
        });
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .switch-box {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        input:checked + .slider {
            background-color: #28a745;
        }
    </style>
</head>
<body>
    <h2>Real-time GPIO Control</h2>
    <button onclick="showForm()">Add GPIO Control</button>
    <div id="switchesContainer"></div>

    <!-- GPIO Control Modal -->
    <div id="controlModal" style="display: none;">
        <h3>Add GPIO Control</h3>
        <label>Device Name:</label>
        <input type="text" id="deviceName">
        <label>GPIO Pin:</label>
        <select id="gpioPin">
            <option value="17">GPIO 17</option>
            <option value="18">GPIO 18</option>
            <option value="22">GPIO 22</option>
            <option value="23">GPIO 23</option>
            <option value="24">GPIO 24</option>
            <option value="25">GPIO 25</option>
        </select>
        <br><br>
        <button onclick="addSwitch()">Submit</button>
        <button onclick="hideForm()">Cancel</button>
    </div>
</body>
</html>
